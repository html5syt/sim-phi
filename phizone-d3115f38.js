const t=hook.define({name:"PhiZone",description:"PhiZone API",contents:[{type:"command",meta:["/pz",w]},{type:"command",meta:["/pzs",w]},{type:"command",meta:["/pzc",async function(t){const a=t||h("请输入谱面ID");if(""===a||null==a)return void l("未输入谱面ID，已取消操作");const n=await async function(t){e("等待服务器响应...");const a=await fetch(o(0|t));if(!a.ok)throw new Error(`${a.status} ${a.statusText}`);const n=((await a.json()).data||[])[0];if(!n||!n.file)return{charts:[]};const s=await fetch(r(n.songId));if(!s.ok)throw new Error(`${s.status} ${s.statusText}`);return p([n],(await s.json()).data)}(a).catch(f);if(console.log(n),n){if(!n.charts.length)return void d(a);await g(n)}}]},{type:"command",meta:["/random",async function(){const t=await async function(){e("等待服务器响应...");const t=await fetch(i());if(!t.ok)throw new Error(`${t.status} ${t.statusText}`);const a=(await t.json()).data,n=await fetch(r(a.songId));if(!n.ok)throw new Error(`${n.status} ${n.statusText}`);return p([a],(await n.json()).data)}().catch(f);if(console.log(t),t){if(!t.charts.length)return void d("<random>");await g(t)}}]}]}),{sendText:e,uploader:a}=hook,n="https://api.phizone.cn",r=(t="")=>`${n}/songs/${t}/`,s=(t=0)=>`${n}/songs/?perpage=1&page=${t}`,o=(t=0)=>`${n}/charts/?perpage=1&page=${t}`,c=(t="")=>`${n}/songs/${t}/charts/`,i=()=>`${n}/charts/random/?rangeFormat=0&rangeFormat=1`,u="PhiZone API v0.8.5",h=t=>prompt(`${u}\n${t}`),l=t=>hook.toast(`${u}\n${t}`),f=t=>{l(`无法连接至服务器\n错误代码：${t.message}`),e("无法连接至服务器")},d=t=>{l(`歌曲ID ${t} 对应的谱面不存在`),e(`歌曲ID ${t} 对应的谱面不存在`)};async function w(t){const a=t||h("请输入歌曲ID");if(""===a||null==a)return void l("未输入歌曲ID，已取消操作");const n=await async function(t){e("等待服务器响应...");const a=await fetch(s(0|t));if(!a.ok)throw new Error(`${a.status} ${a.statusText}`);const n=((await a.json()).data||[])[0];if(!n)return{charts:[]};const r=await fetch(c(n.id));if(!r.ok)throw new Error(`${r.status} ${r.statusText}`);return p(((await r.json()).data||[]).filter((t=>t.file)),n)}(a).catch(f);if(console.log(n),n){if(!n.charts.length)return void d(a);await g(n)}}function p(t,e){return console.log("getData::base",...t),console.log("getData::song",e),{charts:t.map((t=>({id:t.id,chart:t.file,level:`${t.level} Lv.${0|t.difficulty}`,charter:t.authorName.replace(/\[PZUser:\d+:([^\]]+?)(:PZRT)?\]/g,"$1"),assets:t.assets}))),composer:e.authorName,illustration:e.illustration,illustrator:e.illustrator,name:e.title,song:e.file}}async function g(t){const{charts:n}=t,r=[t.song,t.illustration];for(const t of n)t.chart&&r.push(t.chart),t.assets&&r.push(t.assets);const s=new $,o=t=>decodeURIComponent(t.match(/[^/]+$/)[0]);e("获取资源列表..."),await s.add(r,(({url:t,status:e,statusText:a})=>{l(`资源 '${o(t)}' 加载失败\n错误代码：${e} ${a}`)})),await s.start(a.fireProgress.bind(a));const c=async(t,e)=>{const n=await s.getData(t)||new ArrayBuffer(0);a.fireLoad({name:e},n)};await c(t.song,o(t.song)),await c(t.illustration,o(t.illustration));for(let e=0;e<n.length;e++){const r=n[e];r.assets&&await c(r.assets,o(r.assets)),await c(r.chart,o(r.chart));const s=new TextEncoder,i=m(r.id),u=`\n      #\n      Name: ${t.name}\n      Song: ${o(t.song)}\n      Picture: ${o(t.illustration)}\n      Chart: ${o(r.chart)}\n      Level: ${r.level}\n      Composer: ${t.composer}\n      Charter: ${r.charter}\n      Illustrator: ${t.illustrator}\n      Offset: ${i}\n    `,h=s.encode(u);a.fireLoad({name:"info.txt"},h.buffer)}}function $(){this.xhrs=Object.create(null)}function m(t){return"2eb9e940-4350-4509-a244-068abd937f44"===t?-50:0}$.prototype.add=function(t=[],e=(t=>{})){return Promise.all(t.filter((t=>!this.xhrs[t])).map((async t=>{try{const e=await async function(t){try{const e=await fetch(t,{method:"HEAD"}).catch((()=>{throw Object.assign(new Error,{url:t,status:0,statusText:"Network Error"})})),a=e.headers.get("content-length");if(null==a)throw new Error("No Content-Length Header");if(e.ok)return Number(a)}catch{const e=await fetch(t,{method:"GET"}).catch((()=>{throw Object.assign(new Error,{url:t,status:0,statusText:"Network Error"})}));if(e.body.cancel(),!e.ok)throw Object.assign(new Error,{url:t,status:e.status,statusText:e.statusText});return Number(e.headers.get("content-length"))||0}throw Object.assign(new Error,{url:t,status:0,statusText:"Unknown Error"})}(t);this.xhrs[t]={event:{loaded:0,total:e}}}catch(t){e(t)}})))},$.prototype.start=function(t=((...t)=>{})){const e=Object.entries(this.xhrs);return Promise.all(e.map((([e,a])=>function(t,e=(t=>{})){return new Promise(((a,n)=>{const r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="arraybuffer",r.onprogress=e,r.onload=t=>(200===r.status?a:n)(t),r.onerror=n,r.send()}))}(e,(e=>{a.event=e,t(this.loaded,this.total)})).then((t=>a.event=t)).catch((t=>a.event=t)))))},$.prototype.getData=function(t){if(!this.xhrs[t])return null;const{event:e}=this.xhrs[t];return e.loaded>=e.total?e.target.response:null},Object.defineProperty($.prototype,"loaded",{get(){return Object.values(this.xhrs).reduce(((t,e)=>t+e.event.loaded),0)}}),Object.defineProperty($.prototype,"total",{get(){return Object.values(this.xhrs).reduce(((t,e)=>t+Math.max(e.event.loaded,e.event.total)),0)}});export{t as default};
//# sourceMappingURL=phizone-d3115f38.js.map
