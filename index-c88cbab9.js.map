{"version":3,"file":"index-c88cbab9.js","sources":["../src/plugins/demo/index.js"],"sourcesContent":["import { decodeAlt } from '/src/utils/imgAny';\nconst $id = query => document.getElementById(query);\nconst $ = query => document.body.querySelector(query);\nconst flag0 = 'flag{\\x71w\\x71}';\nexport default function() {\n  (function() {\n    const t = new Date();\n    if (t.getDate() !== 1 || t.getMonth() !== 3) return;\n    import('./reverse.js');\n  }());\n  hook.before.set(flag0, () => {\n    const md5 = hook.chartsMD5.get(hook.selectchart.value);\n    console.log(hook.tmps.name);\n    if (md5 === 'ab9d2cc3eb569236ead459ad4caba109') hook.now.set(flag0, loadModYukiOri());\n    else hook.now.delete(flag0);\n  });\n  const id = setInterval(() => {\n    if (!$('.title>small')) return;\n    clearInterval(id);\n    let tid = 3;\n    $('.title>small').addEventListener('click', () => {\n      if (--tid) return;\n      const btn = document.createElement('button');\n      $id('uploader').insertAdjacentElement('afterend', btn);\n      $id('uploader').insertAdjacentText('afterend', ' ');\n      if (new URLSearchParams(location.search).has('test')) {\n        btn.innerText = 'Demo';\n        btn.onclick = function() {\n          btn.onclick = null;\n          btn.remove();\n          const handler = img => hook.uploader.fireLoad({ name: 'demo.zip' }, decodeAlt(img));\n          const xhr = new XMLHttpRequest();\n          xhr.open('GET', '//i0.hdslb.com/bfs/music/1682346166.jpg', true);\n          xhr.responseType = 'blob';\n          xhr.onprogress = evt => hook.uploader.fireProgress(evt.loaded, evt.total);\n          xhr.onloadend = () => createImageBitmap(xhr.response).then(handler);\n          setNoReferrer(() => xhr.send());\n        };\n      } else {\n        btn.innerText = 'Legacy';\n        btn.onclick = function() {\n          btn.onclick = null;\n          btn.remove();\n          location.replace('/sim-phi-legacy');\n        };\n      }\n    });\n  }, 500);\n}\nfunction loadModYukiOri() {\n  console.log('好耶');\n  const analyser = hook.audio.actx.createAnalyser();\n  analyser.fftSize = 4096;\n  // analyser.minDecibels = -180;\n  const getFreq = () => {\n    // progress变为频谱图\n    const bufferLength = analyser.frequencyBinCount;\n    const freq = new Uint8Array(bufferLength);\n    analyser.getByteFrequencyData(freq);\n    const avg = freq.reduce((a, b) => a + b) / bufferLength;\n    return Math.min(1, avg / 255 * 2.15); // FIXME: more accurate formula\n  };\n  let flagMusic = null;\n  let flagPerfect = NaN;\n  let flagGood = NaN;\n  let flagBad = NaN;\n  let flagEm = '';\n  let flagN = false;\n  const setFlag = (flag, em, n) => {\n    flagEm = em;\n    flagN = n;\n    return flag;\n  };\n  return time => {\n    const time1 = time * 1.95;\n    const bgMusic = hook.tmps.bgMusicHack();\n    if (bgMusic && bgMusic !== flagMusic) {\n      bgMusic.connect(analyser); // ?\n      flagMusic = bgMusic;\n    }\n    if (time1 < 168) {\n      hook.stat.numOfNotes = 305;\n      hook.tmps.level = 'lN\\u2002Lv.I2';\n      hook.tmps.progress = time1 / 218;\n    } else if (time1 < 169) {\n      const progress = 1 - (169 - time1) ** 3; // easeCubicOut\n      hook.stat.numOfNotes = 305 + 2195 * progress | 0;\n      hook.tmps.progress = getFreq();\n    } else {\n      hook.stat.numOfNotes = 2500;\n      hook.tmps.progress = getFreq();\n    }\n    if (time1 > 325 && time1 < 358) {\n      // 监听判定变化\n      const statusP = hook.stat.perfect;\n      const statusG = hook.stat.good;\n      const statusB = hook.stat.bad;\n      if (isNaN(flagPerfect)) flagPerfect = statusP;\n      if (isNaN(flagGood)) flagGood = statusG;\n      if (isNaN(flagBad)) flagBad = statusB;\n      if (statusP !== flagPerfect) flagPerfect = setFlag(statusP, '\\uff2f(\\u2267\\u25bd\\u2266)\\uff2f', true);\n      else if (statusG !== flagGood) flagGood = setFlag(statusG, '(\\uff3e\\u03c9\\uff3e)', true);\n      else if (statusB !== flagBad) flagBad = setFlag(statusB, '(\\u2299\\ufe4f\\u2299;)', true);\n      // 监听时间变化\n      if (time1 < 327) setFlag(null, '(\\u2299o\\u2299)', false);\n      else if (time1 > 334 && time1 < 335) setFlag(null, '(\\u2299o\\u2299)', false);\n      else if (time1 > 342 && time1 < 343) setFlag(null, '(\\u2299o\\u2299)', false);\n      else if (time1 > 350 && time1 < 351) setFlag(null, '(\\u2299o\\u2299)', false);\n      else if (!flagN) flagEm = '(\\u2299ω\\u2299)';\n      hook.tmps.combo = flagEm;\n    }\n  };\n}\nfunction setNoReferrer(handler = () => {}) {\n  const meta = Object.assign(document.createElement('meta'), { content: 'no-referrer', name: 'referrer' });\n  document.head.appendChild(meta); handler(); meta.remove();\n}\n"],"names":["$id","query","document","getElementById","$","body","querySelector","flag0","index","t","Date","getDate","getMonth","import","hook","before","set","md5","chartsMD5","get","selectchart","value","console","log","tmps","name","now","analyser","audio","actx","createAnalyser","fftSize","getFreq","o","bufferLength","frequencyBinCount","freq","Uint8Array","getByteFrequencyData","avg","reduce","a","b","Math","min","flagMusic","flagPerfect","NaN","flagGood","flagBad","flagEm","flagN","setFlag","r","flag","em","n","time","time1","bgMusic","bgMusicHack","connect","stat","numOfNotes","level","progress","statusP","perfect","statusG","good","statusB","bad","isNaN","combo","loadModYukiOri","delete","id","setInterval","clearInterval","tid","addEventListener","btn","createElement","insertAdjacentElement","insertAdjacentText","URLSearchParams","location","search","has","innerText","onclick","remove","handler","img","uploader","fireLoad","decodeAlt","xhr","XMLHttpRequest","open","responseType","onprogress","evt","fireProgress","loaded","total","onloadend","createImageBitmap","response","then","meta","Object","assign","content","head","appendChild","setNoReferrer","send","replace"],"mappings":"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"}