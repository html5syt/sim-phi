{"version":3,"file":"export-a9e53641.js","sources":["../src/plugins/export.js"],"sourcesContent":["export default hook.define({\n  name: 'Export',\n  description: 'Export Chart as JSON',\n  contents: [\n    {\n      type: 'command',\n      meta: ['/dl', callback]\n    }\n  ]\n});\nfunction callback() {\n  if (!hook.app.chart) {\n    hook.toast('请先播放谱面');\n    return;\n  }\n  const a = document.createElement('a');\n  const text = JSON.stringify(chartify(hook.app.chart));\n  a.href = URL.createObjectURL(new Blob([text], { type: 'application/json' }));\n  a.download = `chart_${Date.now()}.json`;\n  a.click();\n}\n/**\n * 导出json\n * @param {Chart} json\n */\nfunction chartify(json) {\n  const newChart = {\n    formatVersion: 3,\n    offset: json.offset,\n    numOfNotes: json.numOfNotes,\n    judgeLineList: []\n  };\n  for (const i of json.judgeLineList) {\n    /** @type {JudgeLine} */\n    const newLine = {\n      numOfNotes: i.numOfNotes,\n      numOfNotesAbove: i.numOfNotesAbove,\n      numOfNotesBelow: i.numOfNotesBelow,\n      bpm: i.bpm,\n      speedEvents: [],\n      notesAbove: [],\n      notesBelow: [],\n      judgeLineDisappearEvents: [],\n      judgeLineMoveEvents: [],\n      judgeLineRotateEvents: []\n    };\n    for (const j of i.speedEvents) {\n      if (j.startTime === j.endTime) continue;\n      const newEvent = {};\n      newEvent.startTime = j.startTime;\n      newEvent.endTime = j.endTime;\n      newEvent.value = frix(j.value);\n      newEvent.floorPosition = frix(j.floorPosition);\n      newLine.speedEvents.push(newEvent);\n    }\n    for (const j of i.notesAbove) {\n      const newNote = {};\n      newNote.type = j.type;\n      newNote.time = j.time;\n      newNote.positionX = frix(j.positionX);\n      newNote.holdTime = j.holdTime;\n      newNote.speed = frix(j.speed);\n      newNote.floorPosition = frix(j.floorPosition);\n      newLine.notesAbove.push(newNote);\n    }\n    for (const j of i.notesBelow) {\n      const newNote = {};\n      newNote.type = j.type;\n      newNote.time = j.time;\n      newNote.positionX = frix(j.positionX);\n      newNote.holdTime = j.holdTime;\n      newNote.speed = frix(j.speed);\n      newNote.floorPosition = frix(j.floorPosition);\n      newLine.notesBelow.push(newNote);\n    }\n    for (const j of i.judgeLineDisappearEvents) {\n      if (j.startTime === j.endTime) continue;\n      const newEvent = {};\n      newEvent.startTime = j.startTime;\n      newEvent.endTime = j.endTime;\n      newEvent.start = frix(j.start);\n      newEvent.end = frix(j.end);\n      newLine.judgeLineDisappearEvents.push(newEvent);\n    }\n    for (const j of i.judgeLineMoveEvents) {\n      if (j.startTime === j.endTime) continue;\n      const newEvent = {};\n      newEvent.startTime = j.startTime;\n      newEvent.endTime = j.endTime;\n      newEvent.start = frix(j.start);\n      newEvent.end = frix(j.end);\n      newEvent.start2 = frix(j.start2);\n      newEvent.end2 = frix(j.end2);\n      newLine.judgeLineMoveEvents.push(newEvent);\n    }\n    for (const j of i.judgeLineRotateEvents) {\n      if (j.startTime === j.endTime) continue;\n      const newEvent = {};\n      newEvent.startTime = j.startTime;\n      newEvent.endTime = j.endTime;\n      newEvent.start = frix(j.start);\n      newEvent.end = frix(j.end);\n      newLine.judgeLineRotateEvents.push(newEvent);\n    }\n    newChart.judgeLineList.push(newLine);\n  }\n  return newChart;\n}\nfunction frix(num) {\n  const fn = Math.fround(num);\n  if (!isFinite(fn)) return null;\n  for (let i = 1; i < 1e3; i++) {\n    const str = fn.toPrecision(i);\n    const nstr = Number(str);\n    if (Math.fround(nstr) === fn) {\n      if (parseFloat(str.slice(-1)) !== 3) return nstr;\n      const nstr2 = parseFloat(str.slice(0, -1) + 2);\n      if (fn - nstr2 === nstr - fn && Math.fround(nstr2) === fn) {\n        return nstr2;\n      }\n      return nstr;\n    }\n  }\n  throw new Error('frix error');\n}\n"],"names":["_export","hook","define","name","description","contents","type","meta","app","chart","toast","a","document","createElement","text","JSON","stringify","json","newChart","formatVersion","offset","numOfNotes","judgeLineList","i","newLine","numOfNotesAbove","numOfNotesBelow","bpm","speedEvents","notesAbove","notesBelow","judgeLineDisappearEvents","judgeLineMoveEvents","judgeLineRotateEvents","j","startTime","endTime","newEvent","value","frix","floorPosition","push","newNote","time","positionX","holdTime","speed","start","end","start2","end2","chartify","href","URL","createObjectURL","Blob","download","Date","now","click","num","fn","Math","fround","isFinite","str","toPrecision","nstr","Number","parseFloat","slice","nstr2","Error"],"mappings":"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"}