{"version":3,"file":"phizone-205a40c3.js","sources":["../src/plugins/phizone.js"],"sourcesContent":["export default hook.define({\n  name: 'PhiZone',\n  description: 'PhiZone API',\n  contents: [\n    {\n      type: 'command',\n      meta: ['/pz', dialog]\n    },\n    {\n      type: 'command',\n      meta: ['/random', random]\n    }\n  ]\n});\nconst { msgHandler, uploader } = hook;\nconst host = 'https://api.phi.zone';\nconst ver = 'PhiZone API v0.7.3';\n// eslint-disable-next-line no-alert\nconst vprompt = str => prompt(`${ver}\\n${str}`);\nconst valert = str => hook.toast(`${ver}\\n${str}`);\nasync function dialog(num) {\n  const id = num || vprompt('请输入歌曲ID');\n  if (id === '' || id === null) { valert('未输入歌曲ID，已取消操作'); return }\n  const data = await query(id).catch(err => {\n    valert(`无法连接至服务器\\n错误代码：${err.message}`);\n    msgHandler.sendMessage('无法连接至服务器');\n  });\n  console.log(data);\n  if (!data) return;\n  if (!data.charts.length) { valert(`歌曲ID ${id} 对应的谱面不存在`); return }\n  await readData(data);\n}\nasync function random() {\n  const data = await queryRandom().catch(err => valert(`无法连接至服务器\\n错误代码：${err.message}`));\n  console.log(data);\n  if (!data) return;\n  if (!data.charts.length) { valert(`歌曲ID ${'<random>'} 对应的谱面不存在`); return }\n  await readData(data);\n}\nasync function query(id) {\n  msgHandler.sendMessage('等待服务器响应...');\n  const resS = await fetch(`${host}/songs/${id | 0}/?query_charts=1`);\n  if (!resS.ok) {\n    if (resS.status === 404) return { charts: [] };\n    throw new Error(`${resS.status} ${resS.statusText}`);\n  }\n  const song = await resS.json();\n  return getData(song.charts.filter(a => a.chart), song);\n}\nasync function queryRandom() {\n  msgHandler.sendMessage('等待服务器响应...');\n  const resC = await fetch(`${host}/charts/?pagination=0&query_charts=1`);\n  if (!resC.ok) {\n    if (resC.status === 404) return { charts: [] };\n    throw new Error(`${resC.status} ${resC.statusText}`);\n  }\n  const data = await resC.json();\n  const charts = data.filter(a => a.chart).sort(_ => Math.random() - 0.5);\n  const chart = charts[0];\n  const song = await fetch(`${host}/songs/${chart.song}/`).then(res => res.json());\n  return getData([chart], song);\n}\nfunction getData(base, song) {\n  console.log('getData::base', ...base);\n  console.log('getData::song', song);\n  return {\n    charts: base.map(a => ({\n      id: a.id,\n      chart: a.chart,\n      level: `${a.level}\\u2002Lv.${a.difficulty | 0}`,\n      charter: a.charter.replace(/\\[PZUser:\\d+:([^\\]]+?)(:PZRT)?\\]/g, '$1'),\n      assets: a.assets\n    })),\n    composer: song.composer,\n    illustration: song.illustration,\n    illustrator: song.illustrator,\n    name: song.name,\n    song: song.song\n  };\n}\nasync function readData(data) {\n  const /** @type {array} */ { charts } = data;\n  const urls = [data.song, data.illustration];\n  for (const chart of charts) {\n    if (chart.chart) urls.push(chart.chart);\n    if (chart.assets) urls.push(chart.assets);\n  }\n  const downloader = new Downloader();\n  const dstr = str => decodeURIComponent(str.match(/[^/]+$/)[0]);\n  msgHandler.sendMessage('获取资源列表...');\n  await downloader.add(urls, ({ url, status, statusText }) => {\n    valert(`资源 '${dstr(url)}' 加载失败\\n错误代码：${status} ${statusText}`);\n  });\n  await downloader.start(uploader.fireProgress.bind(uploader));\n  const xhr4 = async(url, name) => {\n    const data1 = await downloader.getData(url) || new ArrayBuffer(0);\n    uploader.fireLoad({ name }, data1); // 以后添加catch\n  };\n  await xhr4(data.song, dstr(data.song));\n  await xhr4(data.illustration, dstr(data.illustration));\n  for (let i = 0; i < charts.length; i++) {\n    const chart = charts[i];\n    if (chart.assets) await xhr4(chart.assets, dstr(chart.assets));\n    await xhr4(chart.chart, dstr(chart.chart));\n    const encoder = new TextEncoder();\n    const offset = getChartOffset(chart.id);\n    const infoText = `\n      #\n      Name: ${data.name}\n      Song: ${dstr(data.song)}\n      Picture: ${dstr(data.illustration)}\n      Chart: ${dstr(chart.chart)}\n      Level: ${chart.level}\n      Composer: ${data.composer}\n      Charter: ${chart.charter}\n      Illustrator: ${data.illustrator}\n      Offset: ${offset}\n    `;\n    const info = encoder.encode(infoText);\n    uploader.fireLoad({ name: 'info.txt' }, info.buffer);\n  }\n}\n/**\n * @typedef {(ev:ProgressEvent<XMLHttpRequest>)} XHR\n * @param {string} url\n * @param {XHR} onprogress\n */\nfunction xhr2(url, onprogress = _ => {}) {\n  return new Promise((resolve, reject) => {\n    const xhr = new XMLHttpRequest();\n    xhr.open('GET', url, true);\n    xhr.responseType = 'arraybuffer';\n    xhr.onprogress = onprogress;\n    xhr.onload = evt => (xhr.status === 200 ? resolve : reject)(evt);\n    xhr.onerror = reject;\n    xhr.send();\n  });\n}\n// async function xhr2(url, onprogress = _ => {}) {\n//   const data = [];\n//   let loaded = 0;\n//   const res = await fetch(url, { method: 'GET' });\n//   if (!res.ok) throw { url, status: res.status, statusText: res.statusText };\n//   const total = Number(res.headers.get('content-length'));\n//   const reader = res.body.getReader();\n//   while (true) {\n//     const { done, value } = await reader.read();\n//     if (done) break;\n//     data.push(value);\n//     loaded += value.length;\n//     onprogress({ loaded, total });\n//   }\n//   return { target: { response: new Blob(data).arrayBuffer() }, loaded, total };\n// }\nasync function getContentLength(url) {\n  try {\n    const res = await fetch(url, { method: 'HEAD' }).catch(() => {\n      throw Object.assign(new Error(), { url, status: 0, statusText: 'Network Error' });\n    });\n    const length = res.headers.get('content-length'); // 踩坑：这里的length是字符串\n    if (length == null) throw new Error('No Content-Length Header');\n    if (res.ok) return Number(length);\n  } catch (_) {\n    const res = await fetch(url, { method: 'GET' }).catch(() => {\n      throw Object.assign(new Error(), { url, status: 0, statusText: 'Network Error' });\n    });\n    res.body.cancel();\n    if (!res.ok) throw Object.assign(new Error(), { url, status: res.status, statusText: res.statusText });\n    return Number(res.headers.get('content-length')) || 0;\n  }\n  throw Object.assign(new Error(), { url, status: 0, statusText: 'Unknown Error' });\n}\nfunction Downloader() {\n  this.xhrs = Object.create(null);\n}\nDownloader.prototype.add = function(urls = [], onerror = _ => {}) {\n  return Promise.all(urls.\n    filter(url => !this.xhrs[url]).\n    map(async url => {\n      try {\n        const total = await getContentLength(url);\n        this.xhrs[url] = { event: { loaded: 0, total } };\n      } catch (result) {\n        onerror(result);\n      }\n    }));\n};\nDownloader.prototype.start = function(onprogress = (..._) => {}) {\n  const entries = Object.entries(this.xhrs);\n  return Promise.all(entries.map(([url, xhr]) => xhr2(url, evt => {\n    xhr.event = evt;\n    onprogress(this.loaded, this.total);\n  }).then(evt => xhr.event = evt).catch(evt => xhr.event = evt)));\n};\nDownloader.prototype.getData = function(url) {\n  if (!this.xhrs[url]) return null;\n  const { event } = this.xhrs[url];\n  if (event.loaded >= event.total) return event.target.response;\n  return null;\n};\nObject.defineProperty(Downloader.prototype, 'loaded', { get() {\n  const values = Object.values(this.xhrs);\n  return values.reduce((loaded, xhr) => loaded + xhr.event.loaded, 0);\n} });\nObject.defineProperty(Downloader.prototype, 'total', { get() {\n  const values = Object.values(this.xhrs);\n  return values.reduce((total, xhr) => total + Math.max(xhr.event.loaded, xhr.event.total), 0);\n} });\nfunction getChartOffset(id) {\n  if (id === 29) return 200; // 45\n  if (id === 31) return 100; // 24\n  if (id === 38) return 175; // 64\n  if (id === 41) return 50; // 43\n  if (id === 42) return 175; // 13\n  if (id === 44) return -150; // 33\n  if (id === 54) return -500; // 8\n  if (id === 57) return 100; // 52\n  if (id === 59) return 50; // 61\n  if (id === 60) return 150; // 74\n  if (id === 63) return 175; // 59\n  if (id === 64) return 150; // 55\n  if (id === 65) return 250; // 22-2\n  if (id === 69) return -100; // 68\n  if (id === 71) return 50; // 72\n  if (id === 73) return 200; // 69-1\n  if (id === 74) return 300; // 80\n  if (id === 76) return -50; // 89\n  if (id === 77) return 300; // 99\n  if (id === 78) return 200; // 69-2\n  if (id === 80) return 200; // 94\n  if (id === 81) return 250; // 97-1\n  if (id === 84) return 250; // 93\n  if (id === 85) return 400; // 91\n  if (id === 87) return -50; // 88\n  if (id === 88) return 225; // 102\n  if (id === 90) return 200; // 101-1\n  if (id === 91) return 200; // 101-2\n  if (id === 93) return 200; // 101-3\n  if (id === 95) return 175; // 21\n  if (id === 100) return 150; // 109\n  if (id === 101) return -100; // 108\n  if (id === 102) return -200; // 110\n  if (id === 103) return -50; // 112\n  if (id === 105) return -400; // 92\n  if (id === 106) return 250; // 97-2\n  if (id === 107) return 150; // 83\n  if (id === 108) return 200; // 113\n  if (id === 110) return 150; // 66\n  if (id === 115) return 200; // 122\n  if (id === 119) return 100; // 126\n  if (id === 133) return -150; // 129\n  if (id === 134) return -100; // 130\n  // handled up to 138\n  return 0;\n}\n"],"names":["phizone","hook","define","name","description","contents","type","meta","async","num","id","vprompt","valert","data","msgHandler","sendMessage","resS","fetch","host","ok","status","charts","Error","statusText","song","json","getData","filter","a","chart","query","catch","err","message","console","log","length","readData","resC","sort","_","Math","random","then","res","queryRandom","uploader","ver","str","prompt","toast","base","map","level","difficulty","charter","replace","assets","composer","illustration","illustrator","urls","push","downloader","Downloader","dstr","decodeURIComponent","match","add","url","start","fireProgress","bind","xhr4","data1","ArrayBuffer","fireLoad","i","encoder","TextEncoder","offset","getChartOffset","infoText","info","encode","buffer","this","xhrs","Object","create","prototype","onerror","Promise","all","total","method","assign","headers","get","Number","body","cancel","getContentLength","event","loaded","result","onprogress","t","entries","xhr","resolve","reject","XMLHttpRequest","open","responseType","onload","evt","send","xhr2","target","response","defineProperty","values","reduce","max"],"mappings":"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"}