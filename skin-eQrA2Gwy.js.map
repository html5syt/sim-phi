{"version":3,"file":"skin-eQrA2Gwy.js","sources":["../src/plugins/skin.js"],"sourcesContent":["import { stringify } from '@/utils/stringify';\nimport { waitForElementById } from '@/utils/waitForElementById';\nexport default hook.define({\n  name: 'Skin',\n  description: 'Customize skin',\n  contents: [\n    {\n      type: 'command',\n      meta: ['/skin', skin]\n    }\n  ]\n});\nconst { audio } = hook;\nfunction skin() {\n  const id = `skin${Date.now()}`;\n  /** @type {ByteData[]} */\n  const files = [];\n  const zip = new hook.ZipReader({ handler: data => files.push(data) });\n  zip.addEventListener('loadstart', () => hook.sendText('加载zip组件...'));\n  zip.addEventListener('read', () => hook.handleFile(id, zip.total, null, done));\n  const uid = Utils.randomUUID();\n  const div = hook.toast(`<a id=\"${uid}\" href=\"#\">点击此处打开文件选择器</a>`);\n  const input = Object.assign(document.createElement('input'), {\n    type: 'file',\n    accept: '',\n    /** @this {HTMLInputElement} */\n    onchange() {\n      if (!this.files) return;\n      const file = this.files[0];\n      const reader = new FileReader();\n      reader.readAsArrayBuffer(file);\n      reader.onload = evt => {\n        if (!evt.target || !(evt.target.result instanceof ArrayBuffer)) return;\n        zip.read({\n          name: file.name,\n          buffer: evt.target.result,\n          path: file.webkitRelativePath || file.name\n        });\n        div.dispatchEvent(new Event('custom-done'));\n      };\n    }\n  });\n  // 直到uid进入DOM树才能触发click事件\n  waitForElementById(uid, elem => {\n    elem.addEventListener('click', () => input.click());\n  });\n  // input.click();\n  async function done() {\n    console.log(files);\n    const config = Object.create(await loadConfig(files));\n    /** @type {Object<string, string[]>} */\n    const alias = {\n      Tap: ['Tap.png', 'click.png'],\n      TapHL: ['TapHL.png', 'click_mh.png'],\n      Drag: ['Drag.png', 'drag.png'],\n      DragHL: ['DragHL.png', 'drag_mh.png'],\n      Hold: ['Hold.png', 'hold.png'],\n      HoldHL: ['HoldHL.png', 'hold_mh.png'],\n      Flick: ['Flick.png', 'flick.png'],\n      FlickHL: ['FlickHL.png', 'flick_mh.png'],\n      HitFX: ['HitFX.png', 'hit_fx.png'],\n      HitSong0: ['HitSong0.ogg', 'Tap.ogg', 'click.ogg'],\n      HitSong1: ['HitSong1.ogg', 'Drag.ogg', 'drag.ogg'],\n      HitSong2: ['HitSong2.ogg', 'Flick.ogg', 'flick.ogg']\n    };\n    // 根据别名补全文件列表\n    /** @type {Map<string, ByteData>} */\n    const entries = new Map();\n    for (const [a, b] of Object.entries(alias)) {\n      for (const i of b) {\n        const file = files.find(j => String(j.name).endsWith(i));\n        if (file) {\n          entries.set(a, file);\n          break;\n        }\n      }\n    }\n    // 读取图片\n    if (entries.has('Tap')) {\n      const img = await createImageBitmap(new Blob([entries.get('Tap').buffer]));\n      const noteScale = 1089 / img.width;\n      hook.noteRender.update('Tap', img, noteScale);\n      if (entries.has('TapHL')) {\n        hook.noteRender.update('TapHL', await createImageBitmap(new Blob([entries.get('TapHL').buffer])), noteScale);\n      } else {\n        hook.noteRender.update('TapHL', img, noteScale);\n      }\n    }\n    if (entries.has('Drag')) {\n      const img = await createImageBitmap(new Blob([entries.get('Drag').buffer]));\n      const noteScale = 1089 / img.width;\n      hook.noteRender.update('Drag', img, noteScale);\n      if (entries.has('DragHL')) {\n        hook.noteRender.update('DragHL', await createImageBitmap(new Blob([entries.get('DragHL').buffer])), noteScale);\n      } else {\n        hook.noteRender.update('DragHL', img, noteScale);\n      }\n    }\n    if (entries.has('Hold')) {\n      const img = await createImageBitmap(new Blob([entries.get('Hold').buffer]));\n      const noteScale = 1089 / img.width;\n      const [bottom, top] = config.holdAtlas;\n      const imgHoldEnd = bottom ? await createImageBitmap(img, 0, 0, img.width, bottom) : hook.res.NoImageBlack;\n      const imgHold = await createImageBitmap(img, 0, bottom, img.width, img.height - bottom - top);\n      const imgHoldHead = top ? await createImageBitmap(img, 0, img.height - top, img.width, top) : hook.res.NoImageBlack;\n      const compacted = config.holdCompact;\n      hook.noteRender.update('HoldEnd', imgHoldEnd, noteScale, compacted);\n      hook.noteRender.update('Hold', imgHold, noteScale, compacted);\n      hook.noteRender.update('HoldHead', imgHoldHead, noteScale, compacted);\n      if (entries.has('HoldHL')) {\n        const img2 = await createImageBitmap(new Blob([entries.get('HoldHL').buffer]));\n        const [bottom2, top2] = config.holdAtlasHL || config.holdAtlasMH || config.holdAtlas;\n        const imgHoldEndHL = bottom2 ? await createImageBitmap(img2, 0, 0, img2.width, bottom2) : hook.res.NoImageBlack;\n        const imgHoldHL = await createImageBitmap(img2, 0, bottom2, img2.width, img2.height - bottom2 - top2);\n        const imgHoldHeadHL = top2 ? await createImageBitmap(img2, 0, img2.height - top2, img2.width, top2) : hook.res.NoImageBlack;\n        hook.noteRender.update('HoldEndHL', imgHoldEndHL, noteScale, compacted);\n        hook.noteRender.update('HoldHL', imgHoldHL, noteScale, compacted);\n        hook.noteRender.update('HoldHeadHL', imgHoldHeadHL, noteScale, compacted);\n      } else {\n        hook.noteRender.update('HoldEndHL', imgHoldEnd, noteScale, compacted);\n        hook.noteRender.update('HoldHL', imgHold, noteScale, compacted);\n        hook.noteRender.update('HoldHeadHL', imgHoldHead, noteScale, compacted);\n      }\n    }\n    if (entries.has('Flick')) {\n      const img = await createImageBitmap(new Blob([entries.get('Flick').buffer]));\n      const noteScale = 1089 / img.width;\n      hook.noteRender.update('Flick', img, noteScale);\n      if (entries.has('FlickHL')) {\n        hook.noteRender.update('FlickHL', await createImageBitmap(new Blob([entries.get('FlickHL').buffer])), noteScale);\n      } else {\n        hook.noteRender.update('FlickHL', img, noteScale);\n      }\n    }\n    if (entries.has('HitFX')) {\n      const img = await createImageBitmap(new Blob([entries.get('HitFX').buffer]));\n      const [x, y] = config.hitFx;\n      const scale = (config.hitFxScale || 1.0) / (img.width / x / 256);\n      const hideParts = config.hideParticles || false;\n      const duration = config.hitFxDuration * 1000 || 500;\n      hook.noteRender.updateFX(img, scale, img.width / x, img.height / y, hideParts, duration);\n    }\n    // 读取音频\n    if (entries.has('HitSong0')) hook.res.HitSong0 = await audio.decode(entries.get('HitSong0').buffer.slice(0));\n    if (entries.has('HitSong1')) hook.res.HitSong1 = await audio.decode(entries.get('HitSong1').buffer.slice(0));\n    if (entries.has('HitSong2')) hook.res.HitSong2 = await audio.decode(entries.get('HitSong2').buffer.slice(0));\n    console.log(config, entries);\n  }\n}\n/** @param {ByteData[]} files */\nfunction loadConfig(files = []) {\n  const config0 = files.find(i => String(i.name).endsWith('config.txt'));\n  if (config0) return parseYAML(stringify(config0.buffer), /;?\\r?\\n/);\n  const config1 = files.find(i => String(i.name).endsWith('info.yml'));\n  if (config1) return parseYAML(stringify(config1.buffer));\n  hook.sendError('未找到config.txt或info.yml');\n  return {};\n}\nfunction parseYAML(text = '', split = /\\r?\\n/) {\n  /** @type {(value:string)=>any} */\n  const parse = value => {\n    try {\n      return JSON.parse(value);\n    } catch (e) {\n      return value;\n    }\n  };\n  return text.split(split).reduce((i, j) => {\n    const [key, value] = j.split(/:(.+)/).map(s => s.trim());\n    if (key) i[key] = parse(value);\n    if (i[key] === 'True') i[key] = true;\n    if (i[key] === 'False') i[key] = false;\n    return i;\n  }, Object.create(null));\n}\n"],"names":["skin","hook","define","name","description","contents","type","meta","id","Date","now","files","zip","ZipReader","handler","data","push","addEventListener","sendText","handleFile","total","done","uid","Utils","randomUUID","div","toast","input","Object","assign","document","createElement","accept","onchange","this","file","reader","FileReader","readAsArrayBuffer","onload","evt","target","result","ArrayBuffer","read","buffer","path","webkitRelativePath","dispatchEvent","Event","async","console","log","config","create","config0","find","i","String","endsWith","parseYAML","stringify","config1","sendError","loadConfig","alias","Tap","TapHL","Drag","DragHL","Hold","HoldHL","Flick","FlickHL","HitFX","HitSong0","HitSong1","HitSong2","entries","Map","a","b","j","set","has","img","createImageBitmap","Blob","get","noteScale","width","noteRender","update","bottom","top","holdAtlas","imgHoldEnd","res","NoImageBlack","imgHold","height","imgHoldHead","compacted","holdCompact","img2","bottom2","top2","holdAtlasHL","holdAtlasMH","imgHoldEndHL","imgHoldHL","imgHoldHeadHL","x","y","hitFx","scale","hitFxScale","hideParts","hideParticles","duration","hitFxDuration","updateFX","audio","decode","slice","waitForElementById","elem","click","text","split","reduce","key","value","map","s","trim","JSON","parse"],"mappings":"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"}